---
title: "Sourcebook > Homeownership > Homeownership rate"
subtitle: "Data sources and methods"
author: "HousingForward Virginia"
date: "Updated on `r Sys.Date()`"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: true
    number_sections: true
---

# Data Sources

### American Community Survey (ACS) {-}
Homeownership rate is derived by dividing the total number of owner-occupied
housing units by the total number of occupied housing units (owner-occupied +
renter-occupied). The source of this data set is the Table B25003 from the 
American Community Survey.

Table B25003 is also provided by race and ethnicity by applying letters A 
through I to the end of the table ID. 

+ **A** is White Alone
+ **B** is Black or African American Alone
+ **C** is American Indian and Alaska Native Alone
+ **D** is Asian Alone
+ **E** is Native Hawaiian and Other Pacific Islander Alone
+ **F** is Some Other Race Alone
+ **G** is Two or More Races
+ **H** is White Alone, Not Hispanic or Latino
+ **I** is Hispanic or Latino

The following script pulls Table B25003 and B25007. 

# Setup
```{r setup, message=FALSE, warning=FALSE}

#Load the the necessary packages to download the data from Census API and set
# global chunk options.

library(tidyverse)
library(tidycensus)

knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
```

# Data collection
```{r data-collect}
# Create an object for all years.
years <- 2010:2021

# Create an object for all tables needed. This includes a table that aggregates 
# to total housing units.
b25003 <- c("B25003", paste0("B25003", LETTERS[2:9]))

b25007 <- "B25007"

# Create a function to convert variable to race or ethnicity variable.
concept_to_race <- function(x) {
  out <- x %>%
    str_remove_all("HOUSEHOLDER") %>%
    str_remove_all("TENURE \\(|\\)") %>%
    str_to_title() %>%
    str_replace_all("And", "and") %>%
    str_replace_all("Or", "or") %>%
    str_remove_all(" Alone")
  
  out
}

# Pull the table variables, excluding Puerto Rico.
b25003_defns <- load_variables(2021, "acs5") %>%
  filter(str_sub(name, end = 6) %in% b25003) %>% 
  filter(str_detect(name, "PR") == FALSE)

b25007_defns <- load_variables(2021, "acs5") %>%
  filter(str_sub(name, end = 6) %in% b25007)%>%
  filter(str_detect(name, "PR")== FALSE)

# Clean the variables provided by Census API and separate needed variables into
# appropriate columns.
b25003_cleaned <- b25003_defns %>%
  mutate(race = concept_to_race(concept)) %>%
  separate(label, into = c("est", "total", "tenure"), sep = "!!") %>% 
  select(variable = name, race, tenure) %>% 
  mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")),
         across(.fns = ~str_remove_all(.x, " --")),
         across(.fns = ~str_replace_all(.x, "total", "All")),
         across(.fns = ~str_replace_all(.x, "Tenure", "All")))

b25007_cleaned <- b25007_defns %>%
  separate(label, into = c("est", "tot", "tenure", "age"), sep = "!!") %>%
  select(variable = name, tenure, age)%>%
    mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")))

# Download the data for all counties in Virginia. Functions interate across all
# tables and all years. If desiring to change to state then input "state" instead
# of "county" and remove 'state = "VA" from function.
output_b25003 <- map_dfr(b25003, function(tb) {
  yearly_data <- map_dfr(years, function(yr) {
    
    acs_pull <- get_acs(
      geography = "county",
      table = tb,
      year = yr,
      state = "VA"
    ) %>%
      left_join(b25003_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, locality = NAME, fips = GEOID, race, tenure,
             estimate, moe)
    
    acs_rearranged
  })
  yearly_data
})

output_b25003_state <- map_dfr(b25003, function(tb) {
  yearly_data <- map_dfr(years, function(yr) {
    
    acs_pull <- get_acs(
      geography = "state",
      table = tb,
      year = yr
    ) %>%
      left_join(b25003_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, locality = NAME, fips = GEOID, race, tenure,
             estimate, moe)
    
    acs_rearranged
  })
  yearly_data
})

output_b25007 <- map_dfr(b25007, function(tb) {
  yearly_data <- map_dfr(years, function(yr) {
    
    acs_pull <- get_acs(
      geography = "county",
      table = tb,
      year = yr,
      state = "VA"
    ) %>%
      left_join(b25007_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, locality = NAME, fips = GEOID, tenure, age,
             estimate, moe)
    
    acs_rearranged
  })
  yearly_data
})

```

# Data Prep
```{r data-prep}
# The previous data output makes it difficult to easily calculate dynamic 
# homeownership rates if wanting to combine multiple localities or races. In
# order to create these calculations more easily, unpivot the columns to rows
# utilizing the pivot_wider function.
output_b25003_wide <- output_b25003 %>% 
  select( -c(variable)) %>% 
  pivot_wider(names_from = tenure,
              values_from = c(estimate, moe)) %>% 
  select(year:race, est_all = estimate_All, est_owner = "estimate_Owner occupied",
         est_renter = "estimate_Renter occupied", moe_all = moe_All, 
         moe_owner = "moe_Owner occupied",
         moe_renter = "moe_Renter occupied")

output_b25003_wide_state <- output_b25003_state %>% 
  select( -c(variable)) %>% 
  pivot_wider(names_from = tenure,
              values_from = c(estimate, moe)) %>% 
  select(year:race, est_all = estimate_All, est_owner = "estimate_Owner occupied",
         est_renter = "estimate_Renter occupied", moe_all = moe_All, 
         moe_owner = "moe_Owner occupied",
         moe_renter = "moe_Renter occupied")

# Clean the locality column to remove comma and Virginia from data, as well as
# converting Bedford city (51515) to Bedford County (51019).

output_b25003_wide <- output_b25003_wide %>%
  mutate(across(.fns = ~str_remove_all(.x, ", Virginia")),
         across(.fns = ~str_replace_all(.x, "Bedford city", "Bedford County")),
         across(.fns = ~str_replace_all(.x, "51515", "51019")))

output_b25007 <- output_b25007 %>%
  mutate(across(.fns = ~str_remove_all(.x, ", Virginia")),
         across(.fns = ~str_replace_all(.x, "Bedford city", "Bedford County")),
         across(.fns = ~str_replace_all(.x, "51515", "51019")))

output_b25007_wide <- output_b25007 %>%
  select( -c(variable)) %>% 
  pivot_wider(names_from = tenure,
              values_from = c(estimate, moe)) %>% 
  select(year:age, est_all = estimate_All, est_owner = "estimate_Owner occupied",
         est_renter = "estimate_Renter occupied", moe_all = moe_All, 
         moe_owner = "moe_Owner occupied",
         moe_renter = "moe_Renter occupied") 

```

# Data export
```{r data-export}
# Write to csv.
write_csv(output_b25003_wide, "data/b25003_wide.csv")
write_csv(output_b25003_wide_state, "data/b25003_state.csv")
write.csv(output_b25007, "data/b25007.csv")
```

