---
title: "Sourcebook > Economic > Household Income"
subtitle: "Data sources and methods"
author: "HousingForward Virginia"
date: "Updated on `r Sys.Date()`"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

## Data Sources

Household income is used throughout Sourcebook to help analyze affordability
across Virginia. The main source for this data is the American Community Survey 
(ACS), which provides median household income by tenure, race/ethnicity, and
age group. Helpful sometimes is a distribution of household incomes
by tenure.

The following tables from ACS are pulled:

* B25119 - Median Household Income by Tenure
* B19013 - Median Household Income 
  + Append letters B-I for race and ethnicity
* B19049 - Median Household Income by Age of Householder
* B25118 - Tenure by Household Income

Median household income provides a better gauge of the **typical** household
income rather than the average because it manages for the impact of outliers. 
Using ACS 1-year estimates is preferable with dollar-denominated data because 
they are based on the most current data, therefore more likely to show 
year-to-year fluctuations.

However, 1-year estimates are only available for localities with populations
over 20,000. In this case, 5-year estimates must be used because it is the only
available data. 

It is also important to note that median household income data collected by the
U.S. Census Bureau is not immediately comparable across time. Inflation impacts
the comparability of dollar-denominated data across time. To account for this, 
dollar-denominated data should be adjusted to the most current year to make 
better comparisons. For more information on this, please see
[Using Dollar-Denominated Data]("https://www.census.gov/content/dam/Census/library/publications/2018/acs/acs_general_handbook_2018_ch10.pdf").


# Setup
```{r Download Median Household Tables, echo=T, message=FALSE, warning=FALSE, paged.print=FALSE, results='hide'}

# Load necessary libraries to pull data.
library(tidyverse)
library(tidycensus)
library(readxl)

knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)

# Create object for years.

years <- 2010:2021

# Create objects for tables needed, which will be B25119, B19013, and B19049.

b25119 <- "B25119"
b19013 <- paste0("B19013", LETTERS[2:9])
b19049 <- "B19049"
b25118 <- "B25118"

# Get variables for Table B25119 and clean the variables.
b25119_defns <- load_variables(2021, "acs5") %>%
  filter(str_sub(name, end = 6) %in% b25119) %>%
  filter(str_detect(name, "PR") == FALSE)

b25119_cleaned <- b25119_defns %>%
  separate(label, c("estimate", "medianhhincome", "total", "tenure"), sep = "!!") %>%
  select(variable = name, medianhhincome, tenure) %>%
  mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")),
         across(.fns = ~str_remove_all(.x, " in the past 12 months \\(\\in 2021 inflation-adjusted dollars\\)\\ --")))

# Get variables for Table B19013, then create a function to pull race or ethnicity
# from the variables. 
b19013_defns <- load_variables(2021, "acs5") %>%
  filter(str_sub(name, end = 7) %in% b19013) %>%
  filter(str_detect(name, "PR") == FALSE)

concept_to_race <- function(x) {
  out <- x %>%
    str_remove_all("MEDIAN HOUSEHOLD INCOME IN THE PAST 12 MONTHS \\(\\IN 2021 INFLATION-ADJUSTED DOLLARS\\)\\ \\(|\\)") %>%
    str_to_title()
}

# Clean up the variables and create a column for race.
b19013_cleaned <- b19013_defns %>%
  mutate(race = concept_to_race(concept)) %>%
  separate(label, c("estimate", "medhhincome"), sep = "!!") %>%
  select(variable = name, medhhincome, race) %>%
  mutate(across(.fns = ~replace_na(.x, "All")),
          across(.fns = ~str_remove_all(.x, ":")),
         across(.fns = ~str_remove_all(.x, "Householder")),
         across(.fns = ~str_remove_all(.x, "Alone")))


# Get variables for Table B19049 and clean the variables.
b19049_defns <- load_variables(2021, "acs5") %>%
  filter(str_sub(name, end = 6) %in% b19049) %>%
  filter(str_detect(name, "PR") == FALSE)

b19049_cleaned <- b19049_defns %>%
  separate(label, c("estimate", "medhhincome", "total", "age"), sep = "!!") %>%
  select(variable = name, medhhincome, age) %>%
  mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")),
         across(.fns =~ str_remove_all(.x, "in the past 12 months \\(\\in 2019 inflation-adjusted dollars\\)\\ --")))

# Get variables for Table B25118 and clean the variables. 
b25118_defns <- load_variables(2021, "acs5") %>%
  filter(str_sub(name, end = 6) %in% b25118) %>%
  filter(str_detect(name, "PR") == FALSE)

b25118_cleaned <- b25118_defns %>%
  separate(label, c("estimate", "total", "tenure", "income"), sep = "!!") %>%
  select(variable = name, tenure, income) %>%
  mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")))
```

# Data collection
```{r}
# Pull data from Census API. You cannot aggregate medians so for the median tables
# you will need to pull data for the state, CBSA, and locality. For now we will just
# pull 5-year estimates and deal with 1-year estimates in 2.0.0.


# Table B25119 - Median Household Income by Tenure

output_b25119_locality <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "county",
    table = b25119,
    survey = "acs5",
    year = yr,
    state = "VA"
  ) %>%
    left_join(b25119_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, locality = NAME, fips = GEOID, tenure,
           estimate, moe)
  
  acs_rearranged
  })

output_b25119_cbsa <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "metropolitan statistical area/micropolitan statistical area",
    table = b25119,
    survey = "acs5",
    year = yr
  ) %>%
    left_join(b25119_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, CBSA = NAME, fips = GEOID, tenure,
           estimate, moe) %>%
    filter(str_detect(CBSA, "VA"))
  
  acs_rearranged
  })

output_b25119_state <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "state",
    table = b25119,
    survey = "acs5",
    year = yr
  ) %>%
    left_join(b25119_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, state = NAME, fips = GEOID, tenure,
           estimate, moe)
  
  acs_rearranged
  })

# Table B19013 - Median Household Income by Race and Ethnicity

output_b19013_locality <- map_dfr(b19013, function(tb) {
  yearly_data <- map_dfr(years, function(yr) {
    
    acs_pull <- get_acs(
      geography = "county",
      table = tb,
      year = yr,
      state = "VA"
    ) %>%
    left_join(b19013_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, locality = NAME, fips = GEOID, race, medhhincome,
             estimate, moe) 
    
    acs_rearranged
  })
  yearly_data
})

output_b19013_cbsa <- map_dfr(b19013, function(tb) {
  yearly_data <- map_dfr(years, function(yr) {
    
    acs_pull <- get_acs(
      geography = "metropolitan statistical area/micropolitan statistical area",
      table = tb,
      year = yr
    ) %>%
    left_join(b19013_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, CBSA = NAME, fips = GEOID, race, medhhincome,
             estimate, moe) %>%
      filter(str_detect(CBSA, "VA"))
    
    acs_rearranged
  })
  yearly_data
})

output_b19013_state <- map_dfr(b19013, function(tb) {
  yearly_data <- map_dfr(years, function(yr) {
    
    acs_pull <- get_acs(
      geography = "state",
      table = tb,
      year = yr
    ) %>%
    left_join(b19013_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, state = NAME, fips = GEOID, race, medhhincome,
             estimate, moe)
    
    acs_rearranged
  })
  yearly_data
})


# Table B19049 - Median Household Income by Age of Householder
output_b19049_locality <- map_dfr(years, function(yr) {
    acs_pull <- get_acs(
      geography = "county",
      table = b19049,
      year = yr
    ) %>%
    left_join(b19049_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, locality = NAME, fips = GEOID, medhhincome, age,
             estimate, moe)
    
    acs_rearranged
  })


output_b19049_cbsa <- map_dfr(years, function(yr) {
    acs_pull <- get_acs(
      geography = "metropolitan statistical area/micropolitan statistical area",
      table = b19049,
      year = yr
    ) %>%
    left_join(b19049_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, CBSA = NAME, fips = GEOID, medhhincome, age,
             estimate, moe) %>%
      filter(str_detect(CBSA, "VA"))
    
    acs_rearranged
  })

output_b19049_state <- map_dfr(years, function(yr) {
    acs_pull <- get_acs(
      geography = "state",
      table = b19049,
      year = yr
    ) %>%
    left_join(b19049_cleaned, by = "variable")
    
    acs_rearranged <- acs_pull %>%
      mutate(year = yr) %>%
      select(variable, year, state = NAME, fips = GEOID, medhhincome, age,
             estimate, moe)
    
    acs_rearranged
  })

# Table B25118 - Tenure by Household Income
# This pull will only be for 5-year estimates for all versions because it represents
# a distribution of incomes at a given point in time. This datapoint can also be aggregated
# because it is a count of households and not a summary measure.

output_b25118 <- map_dfr(years, function(yr) {
  acs_pull <- get_acs(
    geography = "county",
    table = b25118,
    year = yr,
    state = "VA"
  ) %>%
    left_join(b25118_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, locality = NAME, fips = GEOID, tenure, income,
           estimate, moe)
  
  acs_rearranged
})
```

# Data prep
```{r}
# Median household income needs to be adjusted to make comparison between years. This is
# done by utilizing the Annual Average Consumer Price Index Research Series (CPI-U-RS).

cpi <- read_excel("raw/CPI_U_RS.xlsx")
cpi <- cpi %>% 
  rename(year = Year,
         priceindex = cpi_index)

# Join the CPI data frame to the median household income data frames.

cpi_function <- function(x) {
  x %>% 
    left_join(cpi, by = 'year')
}

median_dfs <- list(output_b19013_locality, output_b19013_cbsa, output_b19013_state,
                   output_b19049_locality, output_b19049_cbsa, output_b19049_state,
                   output_b25119_locality, output_b25119_cbsa, output_b25119_state) 


result <- median_dfs %>%
  lapply(cpi_function)

names(result) = c('output_b19013_locality', 'output_b19013_cbsa', 'output_b19013_state',
                   'output_b19049_locality', 'output_b19049_cbsa', 'output_b19049_state',
                   'output_b25119_locality', 'output_b25119_cbsa', 'output_b25119_state')

list2env(result, envir = .GlobalEnv)

adjustment_dfs <- list(output_b19013_locality, output_b19013_cbsa, output_b19013_state,
                   output_b19049_locality, output_b19049_cbsa, output_b19049_state,
                   output_b25119_locality, output_b25119_cbsa, output_b25119_state) 

adjustment <- function(x) {
  transform(x, dollars21 = ((399.2/priceindex)*estimate))
}


dollar_result <- adjustment_dfs %>%
  lapply(adjustment)


names(dollar_result) = c('output_b19013_locality', 'output_b19013_cbsa', 'output_b19013_state',
                   'output_b19049_locality', 'output_b19049_cbsa', 'output_b19049_state',
                   'output_b25119_locality', 'output_b25119_cbsa', 'output_b25119_state')

list2env(dollar_result, envir = .GlobalEnv)

```

# Data export
```{r}
# Write all data to csv.

write_csv(output_b25119_locality, "data/b25119_locality.csv")
write_csv(output_b25119_cbsa, "data/b25119_cbsa.csv")
write_csv(output_b25119_state, "data/b25119_state.csv")
write_csv(output_b19013_locality, "data/b19013_locality.csv")
write_csv(output_b19013_cbsa, "data/b19013_cbsa.csv")
write_csv(output_b19013_state, "data/b19013_state.csv")
write_csv(output_b19049_locality, "data/b19049_locality.csv")
write_csv(output_b19049_cbsa, "data/b19049_cbsa.csv")
write_csv(output_b19049_state, "data/b19049_state.csv")
write_csv(output_b25118, "data/b25118.csv")
```

# Dashboard development

Reserved for future Shiny app development.





