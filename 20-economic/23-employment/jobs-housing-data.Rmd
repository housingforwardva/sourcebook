---
title: "Sourcebook > Economic > Jobs-Housing Imbalance"
subtitle: "Data sources and methods"
author: "HousingForward Virginia"
date: "Updated on `r Sys.Date()`"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

# Data Sources

Measuring the jobs and homes imbalance requires two separate data sources: 
*[Population Estimates Program (PEP)](https://www.census.gov/programs-surveys/popest.html)
*[Local Unemployment Area Statistics (LAUS)](https://www.bls.gov/lau/)

Utilizing these two data sources we are able to understand the number of housing units and make
comparisons to the overall labor force (i.e., all people age 16 and older who are working or actively
looking for work).

```{r}
library(tidycensus)
library(tidyverse)

va_hu_localities <- get_estimates(
  geography = "county",
  state = "VA",
  variables = c("HUEST"),
  year = 2020,
  time_series = TRUE
) %>%
  mutate(longdate = 
    case_when(
      DATE == 1 ~ "4/1/2010",
      DATE == 2 ~ "4/1/2010",
      DATE == 3 ~ "7/1/2010",
      DATE == 4 ~ "7/1/2011",
      DATE == 5 ~ "7/1/2012",
      DATE == 6 ~ "7/1/2013",
      DATE == 7 ~ "7/1/2014",
      DATE == 8 ~ "7/1/2015",
      DATE == 9 ~ "7/1/2016",
      DATE == 10 ~ "7/1/2017",
      DATE == 11 ~ "7/1/2018",
      DATE == 12 ~ "7/1/2019"
    ),
counttype = 
      case_when(
        DATE == 1 ~ "Census population",
        DATE == 2 ~ "Estimates base",
        TRUE ~ "Population estimate"
      ),
year = 
  case_when(
    DATE == 1 ~ 2010,
      DATE == 2 ~ 2010,
      DATE == 3 ~ 2010,
      DATE == 4 ~ 2011,
      DATE == 5 ~ 2012,
      DATE == 6 ~ 2013,
      DATE == 7 ~ 2014,
      DATE == 8 ~ 2015,
      DATE == 9 ~ 2016,
      DATE == 10 ~ 2017,
      DATE == 11 ~ 2018,
      DATE == 12 ~ 2019
  )
  )



library('blscrapeR')
library('tigris')

# The following pulls all localities in Virginia to help iterate through BLS series.
# The TIGRIS package allows us to do this and pull FIPS codes.

virginia <- list_counties("VA")

# The following creates an additional column of series ids based on BLS labels. The
# mutate() function creates a new column called 'seriesid' while the paste0() function
# concatenates the necessary pieces of the series id without spaces.

virginia <- virginia %>% mutate(lfseries = paste0("LAUCN51", county_code, "0000000006")) #labor force
                         
# Only the 'seriesid' field is needed to pull from the BLS API, therefore we need to
# create a list of series ids for all 136 Virginia localities. 

lflist <- list(virginia$lfseries)

# The blscrapeR does not accept a list in its query pull and requires a vector. Therefore, 
# unlist() is used in order to simplifies the list to a vector.

lflist <- unlist(lflist)


# The BLS API has a series query limit of 50, but there are 136 localities (series ids)
# to pull. So we need to split the vector into chunks using the split() function.

lflist <- split(lflist, ceiling(seq_along(lflist)/50))

bls_laborforce_pull <- function(lflist){
  bls_api(lflist,
          startyear = 2010, endyear = 2021, annualaverage = TRUE, Sys.getenv("BLS_KEY")) %>%
    dateCast()
}

va_laborforce <- map_dfr(lflist, bls_laborforce_pull) %>%
  filter(str_detect(periodName, "Annual")) %>%
  mutate(fips = substr(seriesID, 6, 10))

# Combine the two data frames based on year and FIPS.

va_laborforce_hu <- va_laborforce %>%
  left_join(va_hu_localities, by = c('fips' = 'GEOID', 'year' = 'year'))

va_laborforce_hu <- va_laborforce_hu %>%
  rename(hu = value.x, laborforce = value.y)

# Write to csv file.

write_csv(va_laborforce_hu, "data/va_laborforce_housing_2010_2019.csv")
```

