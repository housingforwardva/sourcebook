---
title: "Sourcebook > Rental > Rental vacancy"
subtitle: "Data sources and methods"
author: "HousingForward Virginia"
date: "Updated on `r Sys.Date()`"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: true
    number_sections: true
---
# Data sources

### American Community Survey (ACS) {-}

The American Community Survey is an ongoing survey program of the U.S. Census Bureau. The ACS collects information about the nationâ€™s social, economic, housing, and demographic characteristics on an annual basis. This information provides the most-up-to-date estimates between decennial censuses.

This section uses data from two ACS tables:

* **Table B25003**: Tenure
* **Table B25004**: Vacancy Status

The most recent data used for this section are the **2015-2019 5-year estimates**. These estimates average all survey responses across this period to increase sample sizes and reduce margins of error.

Link: https://www.census.gov/programs-surveys/acs

# Setup

```{r setup, message=FALSE, warning=FALSE}

# Load packages and set global chunk options
library(tidycensus)
library(tidyverse)
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	eval = FALSE
)
```

# Data collection

```{r data-collect}

# Create an objects for years.

years <- 2010:2019

# Get variables for Table B25003

b25003_vars <- load_variables(2019, "acs5") %>%
  filter(str_detect(name, "B25003"))

# Get B25003 data for every locality in Virginia

b25003_raw <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "county",
    table = "B25003",
    year = yr,
    state = "VA"
  )
  
  acs_cleaned <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, NAME, GEOID,
           estimate, moe)
  
  acs_cleaned
})

# Get variables for Table B25004

b25004_vars <- load_variables(2019, "acs5") %>%
  filter(str_detect(name, "B25004"))

# Get B25004 data for every locality in Virginia

b25004_raw <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "county",
    table = "B25004",
    year = yr,
    state = "VA"
  )
  
  acs_cleaned <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, NAME, GEOID,
           estimate, moe)
  
  acs_cleaned
})

```

# Data prep
```{r data-prep}

# Clean B25003 variable names

b25003_vars_clean <- b25003_vars %>%
  separate(label, into = c("est", "tot", "tenure"),
           sep = "!!") %>%
  select(variable = name, tenure)%>%
  mutate(across(.fns = ~str_remove_all(.x, ":"))) %>%
  filter(across(c(tenure), ~!is.na(.x))) %>%
  filter(str_detect(tenure, "Owner occupied") == FALSE) %>% # Keep  only renter housing unit estimates
  mutate(tenure = case_when(
    str_detect(tenure, "Renter occupied") ~ "Renter",
    TRUE ~ tenure)
  )

# Join B25003 variables to data, calculate new sums, and add data reliability info

b25003_data <- b25003_raw %>%
  right_join(b25003_vars_clean, by = "variable") %>% # Use right_join to leave out unnecessary subtotals from data
  select(GEOID, year, tenure, estimate, moe) %>% # Simplify columns
  group_by(GEOID, year, tenure) %>% # Collapse and summarize
  summarise(
    estimate = sum(estimate),
    moe = moe_sum(moe, estimate) # Calculate new group-wise margins of error
  ) %>%
  ungroup()%>%
  mutate(cv = ((moe/1.645)/estimate)*100) %>% # Calculate coefficient of variation
  mutate(reliability = case_when(
    cv < 15 ~ "High reliability",
    cv >= 15 & cv <= 30 ~ "Medium reliability",
    cv > 30 ~ "Low reliability")
  )

# Clean B25004 variable names

b25004_vars_clean <- b25004_vars %>%
  separate(label, into = c("est", "total", "status"),
           sep = "!!") %>%
  select(variable = name, status) %>%
  mutate(across(.fns = ~str_remove_all(.x, ":"))) %>%
  filter(across(c(status), ~!is.na(.x))) %>%
  filter(grepl("rent", status, ignore.case = TRUE))

# Join B25004 variables to data, calculate new sums, and add data reliability info

b25004_data <- b25004_raw %>%
  right_join(b25004_vars_clean, by = "variable") %>% # Use right_join to leave out unnecessary subtotals from data
  select(GEOID, year, status, estimate, moe) %>% # Simplify columns
  group_by(GEOID, year, status) %>% # Collapse and summarize
  summarise(
    estimate = sum(estimate),
    moe = moe_sum(moe, estimate) # Calculate new group-wise margins of error
  ) %>%
  ungroup()%>%
   mutate(cv = ((moe/1.645)/estimate)*100) %>% # Calculate coefficient of variation
  mutate(reliability = case_when(
    cv < 15 ~ "High reliability",
    cv >= 15 & cv <= 30 ~ "Medium reliability",
    cv > 30 ~ "Low reliability")
  )

b25004_data_wide <- b25004_data %>%
  pivot_wider(
    names_from = status,
    values_from = c(estimate, moe, cv, reliability)
  )

rental_vacancy <- merge(b25003_data, b25004_data_wide, by = c("GEOID", "year"))

output_vacancy <- rental_vacancy %>%
  select(fips = GEOID, year, renter_occupied = estimate, for_rent_vacant = `estimate_For rent`, rented_vacant = `estimate_Rented, not occupied`) %>%
  mutate(total_units = select(., renter_occupied:rented_vacant) %>%
           rowSums(na.rm = TRUE))
  
```

# Data export
```{r data-export}

write_csv(output_vacancy, "data/rentervacancy.csv")
```

# Dashboard development

Saved for future dashboard development via Shiny.