---
title: "Sourcebook > Rental > Rent"
subtitle: "Data sources and methods"
author: "HousingForward Virginia"
date: "Updated on `r Sys.Date()`"
output:
  html_document:
    theme: lumen
    toc: true
    toc_float: true
    number_sections: true
---

# Data Sources

### American Community Survey (ACS) {-}
The main data source for rents for renter-occupied housing units is the American
Community Survey. Table B25063 provides a distribution of rental prices for a
locality, while Table B25064 provides the median gross rent. 

Gross rent is defined as contract rent plus the estimated average monthly cost of
utilities such as electricity, gas, and water/sewer and fuels such as oil or kerosene.

Median gross rent is presented in real dollars (dollar value of the corresponding 
year) and must be adjusted to a consistent dollar value. This is done by utilizing 
the **Consumer Price Index (CPI)**. CPI is a measure of the average change over 
time in the prices paid by households for consumer goods. 

### FRED Economic Data | St. Louis Fed {-}

While the Census Bureau utilizes CPI-U, CPI for all Urban Consumers, a more accurate 
CPI to adjust housing costs is the *Consumer Price Index for All Urban Consumers: All Items Less Shelter in U.S. City Average*. This data can be sourced from [FRED Economic Data](https://fred.stlouisfed.org/series/CUUR0000SA0L2).

Adjustments should be made using an average annual CPI.

# Setup
```{r setup, message=FALSE, warning=FALSE}

# Load the necessary packages to pull data from the Census API.
library(tidycensus)
library(tidyverse)
# The lubridate package allows us to easily work with date fields that exist in the
# CPI data file.
library(lubridate)

knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, eval = FALSE)
```

# Data collection
```{r data-collect}
# Create an object for years.
years_full <- 2010:2019
years_partial_1 <- 2010:2014
years_partial_2 <- 2015:2019

# Create object for tables.
b25063 <- "B25063"
b25064 <- "B25064"

# Get variables from tables.

b25063_defns_2019 <- load_variables(2019, "acs5") %>%
  filter(str_sub(name, end = 6) == b25063) %>%
  filter(str_detect(name, "PR") == FALSE)

b25063_defns_2014 <- load_variables(2014, "acs5") %>%
  filter(str_sub(name, end = 6) == b25063) %>%
  filter(str_detect(name, "PR") == FALSE)

b25064_defns <- load_variables(2019, "acs5") %>%
  filter(str_sub(name, end = 6) == b25064) %>%
  filter(str_detect(name, "PR") == FALSE)

# Clean variables and select only needed columns.

b25063_cleaned_2014 <- b25063_defns_2014 %>%
  separate(label, into = c("est", "total", "cash", "rent"), sep = "!!") %>%
  select(variable = name, cash, rent) %>%
  mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")))

b25063_cleaned_2019 <- b25063_defns_2019 %>%
  separate(label, into = c("est", "total", "cash", "rent"), sep = "!!") %>%
  select(variable = name, cash, rent) %>%
  mutate(across(.fns = ~replace_na(.x, "All")),
         across(.fns = ~str_remove_all(.x, ":")))

b25064_cleaned <- b25064_defns %>%
  separate(label, into = c("est", "medgrossrent"), sep = "!!") %>%
  select(variable = name, medgrossrent) %>%
  mutate(across(.fns = ~replace_na(.x, "All")))

# Pull down data from Census API for all localities in Virginia. Note that you 
# cannot aggregate medians and will need to pull down a state value and CBSA
# values. 

# Use "metropolitan statistical area/micropolitan statistical area" for geography
# value when needing CBSA and "state" when needing state value (when using state
# remove the state = "VA" line)

output_b25063_2014 <- map_dfr(years_partial_1, function(yr){
  acs_pull <- get_acs(
    geography = "county",
    table = b25063,
    year = yr,
    state = "VA"
  ) %>%
    left_join(b25063_cleaned_2014, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, locality = NAME, fips = GEOID, cash, rent, 
           estimate, moe)
  
  acs_rearranged
})

output_b25063_2019 <- map_dfr(years_partial_2, function(yr){
  acs_pull <- get_acs(
    geography = "county",
    table = b25063,
    year = yr,
    state = "VA"
  ) %>%
    left_join(b25063_cleaned_2019, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, locality = NAME, fips = GEOID, cash, rent, 
           estimate, moe)
  
  acs_rearranged
})

output_b25064_locality <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "county",
    table = b25064,
    year = yr,
    state = "VA"
  ) %>%
    left_join(b25064_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, locality = NAME, fips = GEOID, medgrossrent, 
           estimate, moe)
  
  acs_rearranged
})

output_b25064_cbsa <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "cbsa",
    table = b25064,
    year = yr
  ) %>%
    left_join(b25064_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, cbsa = NAME, fips = GEOID, medgrossrent, 
           estimate, moe) %>%
    filter(str_detect(cbsa, "VA"))
  
  acs_rearranged
})

output_b25064_state <- map_dfr(years, function(yr){
  acs_pull <- get_acs(
    geography = "state",
    table = b25064,
    year = yr
  ) %>%
    left_join(b25064_cleaned, by = "variable")
  
  acs_rearranged <- acs_pull %>%
    mutate(year = yr) %>%
    select(variable, year, state = NAME, fips = GEOID, medgrossrent, 
           estimate, moe)
  
  acs_rearranged
})

output_b25063 <- rbind(output_b25063_2014, output_b25063_2019)
```

# Data prep

Table B25064 presents median dollar values which is not accurately comparable in
its given form. To compare median dollar values across time, dollar values must
be adjusted to a consistent dollar value.

For this purpose, dollar values for years preceding 2019 are adjusted to 2019 
dollar values. This is done by dividing the average annual CPI for 2019 by the 
year of the given value, then multiplying by the given value.

$2019 dollars = \frac{CPI_1}{CPI_2} * yeardollars$ 

where
$CPI_1$ is the average annual CPI for 2019 and
$CPI_2$ is the average annual CPI for the given year.


```{r data-prep}


# Load the raw csv data file of CPI values by month for rent of primary residence in
# the South.
cpi <- read_csv("raw\\CUUR0000SA0L2.csv")

# Create a column based on the year of CPI value.
cpi$year <- floor_date(cpi$DATE, "year")

# Rename columns and ensure that CPI value is a numeric value.
cpi <- cpi %>%
  rename(cpi_value = CUUR0000SA0L2) %>%
  transform(cpi_value = as.numeric(cpi_value))

# Summarize CPI by year to get average annual CPI. 
annual_cpi <- cpi %>%
  group_by(year) %>%
  summarize(mean = mean(cpi_value))%>%
  mutate(year = as.integer(substring(year, 1,4)))

# Join B25064 tables to the Annual CPI table based on year and then create a 
# column for 2019 dollar value (dollars19) that utilizes the formula above.

# The average annual CPI for 2019 is 234.21450.

b25064_locality <- output_b25064_locality %>%
  left_join(annual_cpi, by = 'year') %>%
  rename(cpi = mean) %>%
  mutate(dollars19 = ((234.21450/cpi)*estimate))

b25064_cbsa <- output_b25064_cbsa %>%
  left_join(annual_cpi, by = 'year') %>%
  rename(cpi = mean) %>%
  mutate(dollars19 = ((234.21450/cpi)*estimate))

b25064_state <- output_b25064_state %>%
  left_join(annual_cpi, by = 'year') %>%
  rename(cpi = mean) %>%
  mutate(dollars19 = ((234.21450/cpi)*estimate))
```


# Data export

```{r data-export}
# Write to csv files.

write_csv(b25064_locality, "data/b25064_locality.csv")
write_csv(b25064_cbsa, "data/b25064_cbsa.csv")
write_csv(b25064_state, "data/b25064_state.csv")
write_csv(output_b25063, "data/b25063_2010_2019.csv")

```

# Dashboard development

Reserved for future Shiny app development.

